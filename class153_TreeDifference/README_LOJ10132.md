# LOJ 10132 异象石

## 题目描述

在一个圆上有n个点，按顺时针编号为0到n-1。有m次操作，每次操作会在两个点之间连一条弦。每次操作后，求所有弦将圆分割成多少个区域。

## 题目链接

[LOJ 10132 异象石](https://loj.ac/problem/10132)

## 输入格式

- 第一行包含一个整数N，表示节点的数量。
- 接下来N-1行，每行包含两个整数u和v，表示节点u和节点v之间有一条边。
- 接下来一行包含一个整数M，表示操作的数量。
- 接下来M行，每行包含一个操作：
  - "+ x" 表示选中节点x
  - "- x" 表示取消选中节点x
  - "?" 表示查询当前选中节点在圆上的最小生成树的边权和

## 输出格式

对于每个"?"操作，输出一行一个整数，表示当前选中节点在圆上的最小生成树的边权和。

## 样例输入

```
6
1 2
1 3
1 4
2 5
2 6
7
+ 1
+ 2
+ 3
+ 5
?
- 2
?
```

## 样例输出

```
4
3
```

## 数据范围

- 1 <= N <= 100000
- 1 <= M <= 100000

## 解题思路

这是一道结合了虚树和树上差分思想的题目。我们需要维护圆上选中点的最小生成树边权和。

### 算法分析

1. **圆上的距离**：
   - 圆上两点间的距离是两点间顺时针和逆时针距离的较小值。
   - 可以通过将圆上的点按照顺时针顺序排列，构建一棵树来处理。

2. **虚树**：
   - 当选中的点数较多时，直接计算最小生成树会超时。
   - 使用虚树技术，只保留关键点构建一棵树，可以大大减少计算量。

3. **最小生成树**：
   - 在圆上，选中点的最小生成树可以通过按照顺时针顺序排序后，连接相邻点来构造。
   - 边权和等于相邻点间距离之和。

4. **实现要点**：
   - 使用DFS序对节点排序
   - 使用单调栈构建虚树
   - 计算虚树上边的权值和

### 时间复杂度

- 预处理阶段：O(N log N)（倍增法求LCA）
- 每次操作：O(k log k)（k为选中点数）
- 总体复杂度：O(N log N + M k log k)

### 空间复杂度

- 树存储：O(N)
- LCA相关数组：O(N log N)
- 虚树相关：O(k)
- 总体复杂度：O(N log N)

## 代码实现

### Java版本

```java
// 详细实现见Code09_AlienStone.java
```

### C++版本

```cpp
// 详细实现见Code09_AlienStone.cpp
```

### Python版本

```python
# 详细实现见Code09_AlienStone.py
```

## 算法要点

1. **虚树构建**：
   - 按DFS序对选中点排序
   - 使用单调栈构建虚树
   - 虚树节点数不超过2k（k为选中点数）

2. **LCA算法**：
   - 使用倍增法预处理LCA，预处理时间复杂度O(N log N)，查询时间复杂度O(log N)。

3. **圆上距离计算**：
   - 圆上两点间距离 = min(|a-b|, n-|a-b|)

## 常见错误与注意事项

1. **虚树构建错误**：
   - 节点排序错误
   - 单调栈维护错误
   - LCA计算错误

2. **边界处理错误**：
   - 选中点数为0或1的特殊情况
   - 根节点的特殊处理
   - 数组越界

3. **精度问题**：
   - 注意整数溢出
   - 使用long long类型存储结果

## 扩展应用

1. **树上差分**：
   - 处理树上路径修改问题
   - 点差分和边差分的应用

2. **虚树应用**：
   - 处理树上多点查询问题
   - 减少计算复杂度

3. **动态最小生成树**：
   - 处理动态加点/删点的最小生成树问题
   - 结合数据结构优化

## 相关题目

1. **LOJ 10131 暗的连锁** - 树上边差分
2. **洛谷 P3258 [JLOI2014] 松鼠的新家** - 树上点差分
3. **Codeforces 1017G The Tree** - 树链剖分线段树
4. **LibreOJ 10134 Dis** - 差分

## 总结

异象石是一道综合性的题目，结合了虚树、LCA、最小生成树等多个算法知识点。通过这道题目，可以深入理解：

1. 虚树的构建方法和应用场景
2. LCA算法在树上问题中的应用
3. 如何处理动态点集的最小生成树问题
4. 树上差分思想的扩展应用

掌握这些知识点对于解决更复杂的树上问题具有重要意义。