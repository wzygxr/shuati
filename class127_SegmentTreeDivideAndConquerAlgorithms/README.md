# 线段树分治 (Segment Tree Divide and Conquer) - Class167

## 概述

线段树分治是一种离线算法技术，主要用于解决带有时间维度的图论问题和动态维护问题。它将操作序列按照时间轴建立线段树，然后通过DFS遍历线段树来处理各个时间区间内的操作。

## 核心思想

1. **离线处理**：将所有操作和查询离线，按照时间建立线段树
2. **区间操作**：将每个操作的影响时间段映射到线段树的节点上
3. **可撤销数据结构**：使用可撤销并查集等支持回滚操作的数据结构
4. **DFS遍历**：通过DFS遍历线段树，处理每个节点的操作并及时回滚

## 关键技术点

### 1. 可撤销并查集 (Rollback DSU)

```java
class RollbackDSU {
    int[] father, size;
    Stack<int[]> rollbackStack = new Stack<>();
    
    int find(int x) {
        while (x != father[x]) x = father[x];
        return x;
    }
    
    void union(int x, int y) {
        int fx = find(x), fy = find(y);
        if (fx == fy) return;
        // 按秩合并
        if (size[fx] < size[fy]) {
            int temp = fx; fx = fy; fy = temp;
        }
        father[fy] = fx;
        size[fx] += size[fy];
        rollbackStack.push(new int[]{fx, fy});
    }
    
    void rollback() {
        int[] op = rollbackStack.pop();
        int fx = op[0], fy = op[1];
        father[fy] = fy;
        size[fx] -= size[fy];
    }
}
```

### 2. 扩展域并查集 (Extended Union Find)

用于二分图检测：

```java
// 对于节点x，其在左侧的编号为x，右侧的编号为x+n
void union(int x, int y) {
    // x的左侧与y的右侧连接
    // y的左侧与x的右侧连接
    union(x, y + n);
    union(y, x + n);
}
```

## 经典题目详解

### 1. 博物馆劫案 (CF601E / Luogu P4585)

**题目描述**：
- 给定n件商品，每件商品有价值和重量
- 支持添加商品、删除商品、查询操作
- 查询操作要求计算背包问题的变形结果

**解法**：
- 线段树分治 + 动态规划
- 将每件商品的有效时间映射到线段树上
- 在DFS过程中维护背包DP状态

**时间复杂度**：O(qk log q + nk)
**空间复杂度**：O(qk)

### 2. 贪玩蓝月 (LOJ #6515)

**题目描述**：
- 双端队列维护装备，支持在两端添加和删除装备
- 查询操作要求在特定特征值范围内选择装备使得战斗力最大

**解法**：
- 线段树分治 + 动态规划
- 将每件装备的有效时间映射到线段树上
- 在DFS过程中维护模意义下的DP状态

**时间复杂度**：O(mp log m)
**空间复杂度**：O(mp)

### 3. 打印所有合法数 (CF981E)

**题目描述**：
- 给定一个数组，初始全为0
- 支持区间加法操作，每种操作只能执行一次
- 查询能通过选择操作得到的所有可能最大值

**解法**：
- 线段树分治 + 位运算优化DP
- 使用位图记录所有可能的状态
- 通过位运算优化状态转移

**时间复杂度**：O(nq log q)
**空间复杂度**：O(n)

### 4. 异或最短路 (CF938G)

**题目描述**：
- 维护一个图，支持加边、删边操作
- 查询两点间路径边权异或和的最小值

**解法**：
- 线段树分治 + 带权并查集 + 线性基
- 利用线性基维护异或运算的性质
- 通过带权并查集维护连通性和路径异或值

**时间复杂度**：O((n+q) log q log V)
**空间复杂度**：O(n + q)

### 5. 八纵八横 (Luogu P3733)

**题目描述**：
- 维护一个图，支持加边、删边、修改边权操作
- 查询从1号点出发回到1号点路径边权异或和的最大值

**解法**：
- 线段树分治 + 带权并查集 + 线性基
- 使用BitSet处理大整数异或运算
- 维护线性基支持异或最大值查询

**时间复杂度**：O((n+q) log q L)
**空间复杂度**：O(nL + qL)，其中L为边权长度

### 6. 火星商店 (Luogu P4585)

**题目描述**：
- 维护n个商店，每个商店有商品
- 支持添加商品、查询操作
- 查询要求在特定商店范围内和时间范围内找到异或最大值

**解法**：
- 线段树分治 + 可持久化Trie
- 二维限制（商店编号和时间）的处理
- 使用可持久化Trie维护异或最大值查询

**时间复杂度**：O((n+q) log q log V)
**空间复杂度**：O((n+q) log V)

### 7. 最小异或查询 (ABC308G)

**题目描述**：
- 维护一个集合，支持添加数字、删除数字、查询操作
- 查询操作要求找到集合中任意两个数的异或最小值

**解法**：
- 01Trie + 在线维护
- 通过Trie维护数字集合
- 实时计算最小异或值

**时间复杂度**：O(q log V)
**空间复杂度**：O(q log V)

### 8. 二分图检测 (CF813F)

**题目描述**：
- 维护一个图，支持加边、删边操作
- 每次操作后检测图是否为二分图

**解法**：
- 线段树分治 + 扩展域并查集
- 使用扩展域并查集维护二分图性质
- 通过线段树分治处理时间维度

**时间复杂度**：O((n+q) log q)
**空间复杂度**：O(n + q)

## 更多线段树分治经典题目

### LeetCode题目

#### 1. 动态图连通性 (Dynamic Graph Connectivity)
- **题目链接**: https://leetcode.com/problems/dynamic-graph-connectivity/
- **难度**: Hard
- **标签**: Union Find, Segment Tree, Divide and Conquer
- **题目描述**: 支持动态加边、删边操作，查询两点间连通性
- **解法**: 线段树分治 + 可撤销并查集
- **时间复杂度**: O((n + m) log m)
- **空间复杂度**: O(n + m)

#### 2. 不良数对计数 (Count Number of Bad Pairs)
- **题目链接**: https://leetcode.com/problems/count-number-of-bad-pairs/
- **难度**: Medium
- **标签**: Segment Tree, Divide and Conquer, Math
- **题目描述**: 统计满足特定条件的数对数量
- **解法**: 线段树分治 + 数学变换
- **时间复杂度**: O(n log n)
- **空间复杂度**: O(n)

#### 3. 带阈值的图连通性 (Graph Connectivity With Threshold)
- **题目链接**: https://leetcode.com/problems/graph-connectivity-with-threshold/
- **难度**: Hard
- **标签**: Union Find, Math, Segment Tree, Divide and Conquer
- **题目描述**: 给定n个城市，编号1到n，当两个城市的最大公约数大于threshold时它们直接相连，查询任意两个城市是否连通
- **解法**: 线段树分治 + 可撤销并查集
- **时间复杂度**: O(n log n + q log n)
- **空间复杂度**: O(n)

### Codeforces题目

#### 1. 唯一出现次数 (Unique Occurrences) - 1681F
- **题目链接**: https://codeforces.com/contest/1681/problem/F
- **难度**: 2600
- **标签**: Segment Tree, Divide and Conquer, Union Find, Tree
- **题目描述**: 统计树上路径中唯一出现的颜色数量
- **解法**: 线段树分治 + 可撤销并查集
- **时间复杂度**: O((n + m) log m)
- **空间复杂度**: O(n + m)

#### 2. 边着色 (Painting Edges) - 576E
- **题目链接**: https://codeforces.com/contest/576/problem/E
- **难度**: 3300
- **标签**: Segment Tree, Divide and Conquer, Union Find, Graph
- **题目描述**: 给边着色使得每种颜色构成的子图都是二分图
- **解法**: 线段树分治 + 多个扩展域并查集
- **时间复杂度**: O((n + m) log m)
- **空间复杂度**: O(n + m)

### 洛谷题目

#### 1. 二分图 /【模板】线段树分治 - P5787
- **题目链接**: https://www.luogu.com.cn/problem/P5787
- **难度**: 省选/NOI-
- **标签**: 线段树分治, 扩展域并查集, 二分图
- **题目描述**: 维护动态图使其为二分图
- **解法**: 线段树分治 + 扩展域并查集
- **时间复杂度**: O((n + m) log m)
- **空间复杂度**: O(n + m)

#### 2. 最小mex生成树 - P5631
- **题目链接**: https://www.luogu.com.cn/problem/P5631
- **难度**: 省选/NOI-
- **标签**: 线段树分治, 并查集, 生成树, 二分
- **题目描述**: 求生成树使得边权集合的mex最小
- **解法**: 线段树分治 + 可撤销并查集 + 二分答案
- **时间复杂度**: O((n + m) log m log n)
- **空间复杂度**: O(n + m)

#### 3. 大融合 - P4219
- **题目链接**: https://www.luogu.com.cn/problem/P4219
- **难度**: 省选/NOI-
- **标签**: 线段树分治, 并查集, 图论
- **题目描述**: 支持加边和查询边负载，边负载定义为删去该边后两个连通块大小的乘积
- **解法**: 线段树分治 + 可撤销并查集
- **时间复杂度**: O((n + m) log m)
- **空间复杂度**: O(n + m)

#### 4. 连通图 - P5227
- **题目链接**: https://www.luogu.com.cn/problem/P5227
- **难度**: 省选/NOI-
- **标签**: 线段树分治, 并查集, 图论
- **题目描述**: 给定初始连通图，每次删除一些边，查询是否仍连通
- **解法**: 线段树分治 + 可撤销并查集
- **时间复杂度**: O((n + m) log m)
- **空间复杂度**: O(n + m)

### AtCoder题目

#### 1. 细胞分裂 (Cell Division) - AGC010C
- **题目链接**: https://atcoder.jp/contests/agc010/tasks/agc010_c
- **难度**: 2300
- **标签**: Union Find, Divide and Conquer
- **题目描述**: 分割矩形并计算每次分割后的连通分量数
- **解法**: 线段树分治 + 可撤销并查集
- **时间复杂度**: O((n + m) log m)
- **空间复杂度**: O(n + m)

## 算法复杂度分析

线段树分治的典型复杂度：
- 时间复杂度：O((n + m) log m * k)
- 空间复杂度：O((n + m) log m)

其中：
- n为数据规模（点数、商品数等）
- m为操作数
- k为单次操作的复杂度
- log m来自于线段树的深度

## 实现要点

1. **不能路径压缩**：为了支持撤销操作，只能使用按秩合并
2. **离线处理**：所有操作必须预先知道
3. **精确回滚**：每次操作后必须准确回滚到操作前状态
4. **时间区间映射**：将操作的生效时间区间正确映射到线段树节点
5. **合理选择数据结构**：根据具体问题选择合适的可撤销数据结构

## 应用场景

线段树分治主要适用于以下场景：

1. **动态图问题**：支持加边、删边操作的图论问题
2. **区间维护问题**：需要维护某个区间内有效操作的问题
3. **可撤销操作**：需要支持操作回滚的数据结构问题
4. **离线查询**：所有查询可以预先知道的情况

## 解题思路与技巧总结

1. **识别问题特征**：
   - 问题中存在时间维度或区间有效性
   - 支持添加和删除操作
   - 可以离线处理所有操作和查询

2. **关键步骤**：
   - 离线处理所有操作，确定每个操作的有效时间区间
   - 构建时间轴线段树，将操作映射到对应的区间
   - 选择合适的可撤销数据结构（并查集、线性基等）
   - DFS遍历线段树，处理区间操作并在回溯时回滚

3. **优化技巧**：
   - 使用按秩合并代替路径压缩以支持撤销
   - 合理设计数据结构以提高回滚效率
   - 对于大规模数据，考虑位运算和空间优化

4. **常见误区**：
   - 忽略路径压缩对撤销的影响
   - 时间区间映射错误
   - 回滚操作不完整导致状态错误

5. **工程化考量**：
   - 异常处理：处理无效操作和边界情况
   - 内存管理：避免过大的数据结构导致内存溢出
   - 性能优化：针对特定问题调整数据结构实现

通过掌握线段树分治这一强大的离线算法技术，可以高效解决许多动态维护问题，特别是在图论和数据结构领域有着广泛的应用。

1. **动态图问题**：加边、删边操作下的图性质维护
2. **二分图维护**：动态维护图的二分性
3. **连通性查询**：动态图的连通性相关查询
4. **生成树问题**：动态维护生成树相关性质
5. **异或相关问题**：维护异或运算的性质和查询
6. **背包问题**：动态维护背包状态

## 注意事项

1. 可撤销并查集不能使用路径压缩，只能按秩合并
2. 线段树分治是离线算法，不支持在线查询
3. 每个操作的影响时间区间要正确计算
4. 回滚操作必须与合并操作一一对应
5. 注意空间复杂度，线段树分治通常空间消耗较大